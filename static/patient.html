<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Patient Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { padding-top: 70px; background-color: #f7f9fb; }
    .metric-card { 
      border-radius:8px; 
      padding:15px; 
      margin-bottom:20px; 
      border:1px solid #ccc; 
      background:white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .alert-log { 
      background:#ffdddd; 
      padding:6px; 
      margin-bottom:4px; 
      border-radius:4px; 
      border-left: 4px solid #dc3545;
      font-size: 14px;
    }
    #logs { 
      max-height: 300px; 
      overflow:auto; 
      border:1px solid #ddd; 
      padding:10px; 
      background:white;
      border-radius:8px;
    }
    canvas {
      width: 100% !important;
      height: 220px !important;
      margin-top: 10px;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="dashboard.html">← Back to Dashboard</a>
  </div>
</nav>

<div class="container mt-4">
  <h3 id="patient-title" class="mb-4">Patient: -</h3>

  <div class="row">
    <div class="col-md-4">
      <div class="metric-card text-center">
        <h5>Latency</h5>
        <p><span id="lat">-</span> ms</p>
        <canvas id="lat-chart"></canvas>
      </div>
    </div>
    <div class="col-md-4">
      <div class="metric-card text-center">
        <h5>Jitter</h5>
        <p><span id="jitter">-</span> ms</p>
        <canvas id="jitter-chart"></canvas>
      </div>
    </div>
    <div class="col-md-4">
      <div class="metric-card text-center">
        <h5>PDR</h5>
        <p><span id="pdr">-</span></p>
        <canvas id="pdr-chart"></canvas>
      </div>
    </div>
  </div>

  <h4 class="mt-4">Alerts & Logs</h4>
  <div id="logs"></div>
</div>

<script>
function getQueryParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

const pid = getQueryParam('pid') || "unknown";
document.getElementById('patient-title').textContent = "Patient: " + pid;

const ws = new WebSocket("ws://" + location.host + "/ws/dashboard");

function addLog(text) {
  const d = document.getElementById("logs");
  const p = document.createElement("div");
  p.textContent = new Date().toLocaleTimeString() + " — " + text;
  p.className = 'alert-log';
  d.prepend(p);
}

// Chart.js setup
function createLineChart(ctx, label, color) {
  return new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{ label, data: [], borderColor: color, fill: false, tension: 0.3 }] },
    options: {
      animation: false,
      scales: { x: { display: false }, y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });
}

function createBarChart(ctx, label, color) {
  return new Chart(ctx, {
    type: 'bar',
    data: { labels: [], datasets: [{ label, data: [], backgroundColor: color }] },
    options: {
      animation: false,
      scales: { y: { beginAtZero: true, max: 1 } },
      plugins: { legend: { display: false } }
    }
  });
}

// Create charts
const latencyChart = createLineChart(document.getElementById("lat-chart"), "Latency", "#0d6efd");
const jitterChart = createLineChart(document.getElementById("jitter-chart"), "Jitter", "#fd7e14");
const pdrChart = createBarChart(document.getElementById("pdr-chart"), "PDR", "#198754");

ws.onopen = () => addLog("Connected to collector for " + pid);
ws.onclose = () => addLog("Disconnected.");

let seqPrev = 0;
let receivedCount = 0;

ws.onmessage = (ev) => {
  const obj = JSON.parse(ev.data);
  if ((obj.patient_id || "unknown") !== pid) return;
  const payload = obj.payload || {};

  // Update latency
  const lat = obj.latency_ms ?? 0;
  document.getElementById('lat').textContent = lat;
  const time = new Date().toLocaleTimeString().split(" ")[0];
  latencyChart.data.labels.push(time);
  latencyChart.data.datasets[0].data.push(lat);
  if (latencyChart.data.labels.length > 20) {
    latencyChart.data.labels.shift();
    latencyChart.data.datasets[0].data.shift();
  }
  latencyChart.update();

  // Update jitter
  const prev_jitter = parseFloat(document.getElementById('jitter').dataset.prev || 0);
  const jitter = Math.abs(lat - prev_jitter);
  document.getElementById('jitter').textContent = jitter.toFixed(2);
  document.getElementById('jitter').dataset.prev = lat;
  jitterChart.data.labels.push(time);
  jitterChart.data.datasets[0].data.push(jitter);
  if (jitterChart.data.labels.length > 20) {
    jitterChart.data.labels.shift();
    jitterChart.data.datasets[0].data.shift();
  }
  jitterChart.update();

  // Update PDR
  const seq = obj.seq ?? 0;
  if (seq > seqPrev) {
    receivedCount++;
    seqPrev = seq;
  }
  const pdr = seq ? (receivedCount / seq).toFixed(2) : 0;
  document.getElementById('pdr').textContent = pdr;
  pdrChart.data.labels.push(time);
  pdrChart.data.datasets[0].data.push(pdr);
  if (pdrChart.data.labels.length > 20) {
    pdrChart.data.labels.shift();
    pdrChart.data.datasets[0].data.shift();
  }
  pdrChart.update();

  // Alerts
  if (payload.spo2 !== undefined && payload.spo2 < 92) addLog("ALERT: SpO₂=" + payload.spo2);
  if (payload.ecg !== undefined && payload.ecg > 140) addLog("ALERT: HR=" + payload.ecg);
};
</script>
</body>
</html>
